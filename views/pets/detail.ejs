<%- include('../partials/header', { title: title }) %>

<div class="container-fluid">
    <div class="row">
        <!-- Left Side - Pet Info Container -->
        <div class="col-md-8">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <nav aria-label="breadcrumb" class="mt-3">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/pets">My Pets</a></li>
                                <li class="breadcrumb-item active"><%= pet.name %></li>
                            </ol>
                        </nav>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="mb-0">
                                    <% 
                                        const speciesEmoji = {
                                            'dragon': 'üêâ',
                                            'cat': 'üê±', 
                                            'dog': 'üê∂',
                                            'rat': 'üêÄ',
                                            'elf': 'üßù',
                                            'robot': 'ü§ñ',
                                            'wolf': 'üê∫',
                                            'deer': 'ü¶å',
                                            'duck': 'ü¶Ü',
                                            'bear': 'üêª'
                                        };
                                    %>
                                    <%= speciesEmoji[pet.species] || 'üêæ' %> <%= pet.name %>
                                    <span class="badge bg-<%= 
                                        pet.rarity === 'Legendary' ? 'danger' : 
                                        pet.rarity === 'Epic' ? 'warning' :
                                        pet.rarity === 'Rare' ? 'info' : 'secondary'
                                    %> float-end"><%= pet.rarity %></span>
                                </h2>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Pet Information -->
                                    <div class="col-12">
                                        <h5>Basic Information</h5>
                                        <p><strong>Species:</strong> <%= pet.species.charAt(0).toUpperCase() + pet.species.slice(1) %></p>
                                        <p><strong>Birth Date:</strong> <%= pet.birthDate.toLocaleDateString() %></p>
                                        
                                        <p><strong>Trait:</strong> 
                                            <span class="badge bg-primary me-1 mb-1"><%= pet.trait || 'None' %></span>
                                        </p>
                                        
                                        <p><strong>Accessory:</strong> 
                                            <span class="badge bg-success me-1 mb-1">
                                                <% if (pet.accessory && pet.accessory !== 'None') { %>
                                                    <%= pet.accessory %>
                                                <% } else { %>
                                                    None
                                                <% } %>
                                            </span>
                                        </p>

                                        <!-- Trait Interaction Hint -->
                                        <% if (pet.trait && pet.trait !== 'None') { %>
                                            <div class="alert alert-info mt-3">
                                                <small>üí° <strong>Tip:</strong> Click on your pet's image to see their special trait in action!</small>
                                            </div>
                                        <% } %>
                                        
                                        <!-- Status Section -->
                                        <h5 class="mt-4">Status</h5>
                                        
                                        <div class="mb-3">
                                            <label>Hunger: <%= pet.stats.hunger %>/100</label>
                                            <div class="progress">
                                                <div class="progress-bar bg-<%= pet.stats.hunger > 50 ? 'success' : 'warning' %>" 
                                                     style="width: <%= pet.stats.hunger %>%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label>Happiness: <%= pet.stats.happiness %>/100</label>
                                            <div class="progress">
                                                <div class="progress-bar bg-<%= pet.stats.happiness > 50 ? 'success' : 'warning' %>" 
                                                     style="width: <%= pet.stats.happiness %>%"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label>Energy: <%= pet.stats.energy %>/100</label>
                                            <div class="progress">
                                                <div class="progress-bar bg-<%= pet.stats.energy > 50 ? 'success' : 'warning' %>" 
                                                     style="width: <%= pet.stats.energy %>%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Accessory Selection -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5>Customize Your Pet</h5>
                                        <form method="POST" action="/pets/<%= pet._id %>/accessory" class="mb-3">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="accessory" value="None" id="accNone" 
                                                               <%= pet.accessory === 'None' ? 'checked' : '' %>>
                                                        <label class="form-check-label" for="accNone">
                                                            ‚ùå None
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="accessory" value="Bow" id="accBow"
                                                               <%= pet.accessory === 'Bow' ? 'checked' : '' %>>
                                                        <label class="form-check-label" for="accBow">
                                                            üéÄ Bow
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="accessory" value="Hat" id="accHat"
                                                               <%= pet.accessory === 'Hat' ? 'checked' : '' %>>
                                                        <label class="form-check-label" for="accHat">
                                                            üé© Hat
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-outline-success mt-2">Update Accessory</button>
                                        </form>
                                    </div>
                                </div>

                                <!-- Care buttons -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h5>Care for Your Pet</h5>
                                        <div class="d-grid gap-2 d-md-flex">
                                            <form method="POST" action="/pets/<%= pet._id %>/care" class="me-2" id="feedForm">
                                                <input type="hidden" name="action" value="feed">
                                                <button type="submit" class="btn btn-success care-btn" data-action="feed">üçñ Feed</button>
                                            </form>
                                            <form method="POST" action="/pets/<%= pet._id %>/care" class="me-2" id="playForm">
                                                <input type="hidden" name="action" value="play">
                                                <button type="submit" class="btn btn-info care-btn" data-action="play">üéæ Play</button>
                                            </form>
                                            <form method="POST" action="/pets/<%= pet._id %>/care" id="restForm">
                                                <input type="hidden" name="action" value="rest">
                                                <button type="submit" class="btn btn-warning care-btn" data-action="rest">üò¥ Rest</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <% if (pet.needsCare && pet.needsCare()) { %>
                                    <div class="alert alert-warning mt-3">
                                        <strong>‚ö†Ô∏è Attention!</strong> Your pet needs care! Please feed, play, or let it rest.
                                    </div>
                                <% } %>
                            </div>
                            <div class="card-footer">
                                <form action="/pets/<%= pet._id %>/delete" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-danger" 
                                            onclick="return confirm('Are you sure you want to release <%= pet.name %>? This action cannot be undone!')">
                                        üö™ Release Pet
                                    </button>
                                </form>
                                <a href="/pets" class="btn btn-outline-secondary float-end">Back to List</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Large Pet Image (Outside Container) -->
        <div class="col-md-4 pe-0">
            <div class="pet-image-sidebar">
                <div class="text-center">
                    <div class="pet-image-container" id="petImageContainer">
                        <img src="<%= pet.imageUrl %>" 
                             alt="<%= pet.name %> the <%= pet.species %>" 
                             class="large-pet-image interactive-pet"
                             id="interactivePetImage"
                             data-trait="<%= pet.trait || 'None' %>">
                        <!-- Trait Effect Overlay - Positioned over pet image -->
                        <div class="trait-effect-overlay" id="traitEffectOverlay">
                            <img id="traitEffectImage" src="" alt="Trait Effect" class="trait-effect-image">
                        </div>
                        <!-- Care Action Overlay - Positioned over pet image -->
                        <div class="care-effect-overlay" id="careEffectOverlay">
                            <img id="careEffectImage" src="" alt="Care Effect" class="care-effect-image">
                        </div>
                    </div>
                    <h3 class="pet-name-sidebar mt-3"><%= pet.name %></h3>
                    <% if (pet.accessory && pet.accessory !== 'None') { %>
                        <p class="text-muted">
                            <% if (pet.accessory === 'Bow') { %>
                                üéÄ With <%= pet.accessory %> Accessory
                            <% } else if (pet.accessory === 'Hat') { %>
                                üé© With <%= pet.accessory %> Accessory
                            <% } %>
                        </p>
                    <% } %>
                    <!-- Trait Interaction Indicator -->
                    <% if (pet.trait && pet.trait !== 'None') { %>
                        <div class="trait-interaction-hint">
                            <small class="text-muted">‚ú® Click me to see my special trait!</small>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Large Pet Image Styles */
.large-pet-image {
    width: 100%;
    max-width: 500px;
    height: auto;
    object-fit: contain;
    background: transparent;
    transition: all 0.5s ease;
    cursor: pointer;
}

.interactive-pet {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.pet-image-sidebar {
    position: fixed;
    right: 0;
    top: 0;
    height: 100vh;
    width: 33.333%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: transparent;
    padding: 2rem;
}

.pet-name-sidebar {
    font-weight: bold;
    color: #495057;
    font-size: 2rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.pet-image-container {
    position: relative;
    display: inline-block;
}

.trait-interaction-hint {
    margin-top: 10px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
}

/* Trait Effect Overlay - Positioned over pet image */
.trait-effect-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: none;
    z-index: 10;
}

.trait-effect-image {
    max-width: 80%;
    max-height: 80%;
    opacity: 0;
    transition: opacity 0.5s ease;
}

/* Care Effect Overlay - Positioned over pet image */
.care-effect-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    justify-content: center;
    align-items: center;
    pointer-events: none;
    z-index: 15;
}

.care-effect-image {
    max-width: 90%;
    max-height: 90%;
    opacity: 0;
    transition: opacity 0.5s ease;
}

/* Care Action Animations */
.care-feeding .care-effect-image {
    animation: feedingEffect 3s ease-in-out;
}

.care-playing .care-effect-image {
    animation: playingEffect 3s ease-in-out;
}

.care-resting .care-effect-image {
    animation: restingEffect 3s ease-in-out;
}

/* Trait-specific animations */
.trait-fire-breath .trait-effect-image {
    animation: fireEffect 3s ease-in-out;
}

.trait-glowing .trait-effect-image {
    animation: glowEffect 3s ease-in-out;
}

.trait-can-sing .trait-effect-image {
    animation: singEffect 3s ease-in-out;
}

.trait-water-breathing .trait-effect-image {
    animation: waterEffect 3s ease-in-out;
}

.trait-invisible .interactive-pet {
    animation: invisibleEffect 3s ease-in-out;
}

.trait-flying .interactive-pet {
    animation: flyingEffect 3s ease-in-out;
}

.trait-fast-moving .interactive-pet {
    animation: fastMovingEffect 3s ease-in-out;
}

.trait-giant .interactive-pet {
    animation: giantEffect 3s ease-in-out;
}

.trait-tiny .interactive-pet {
    animation: tinyEffect 3s ease-in-out;
}

/* Care Action Animation Keyframes */
@keyframes feedingEffect {
    0% { opacity: 0; transform: scale(0.8) rotate(-10deg); }
    25% { opacity: 1; transform: scale(1.1) rotate(0deg); }
    50% { opacity: 1; transform: scale(1.2) rotate(10deg); }
    75% { opacity: 0.8; transform: scale(1.1) rotate(0deg); }
    100% { opacity: 0; transform: scale(0.8) rotate(-10deg); }
}

@keyframes playingEffect {
    0% { opacity: 0; transform: scale(0.8) translateY(20px); }
    25% { opacity: 1; transform: scale(1.1) translateY(0); }
    50% { opacity: 1; transform: scale(1.2) translateY(-10px) rotate(5deg); }
    75% { opacity: 0.8; transform: scale(1.1) translateY(0) rotate(-5deg); }
    100% { opacity: 0; transform: scale(0.8) translateY(20px); }
}

@keyframes restingEffect {
    0% { opacity: 0; transform: scale(0.9); filter: brightness(1); }
    25% { opacity: 0.8; transform: scale(1); filter: brightness(0.8); }
    50% { opacity: 1; transform: scale(1.05); filter: brightness(0.7) blur(1px); }
    75% { opacity: 0.8; transform: scale(1); filter: brightness(0.8); }
    100% { opacity: 0; transform: scale(0.9); filter: brightness(1); }
}

/* Trait Animation Keyframes */
@keyframes fireEffect {
    0% { opacity: 0; transform: scale(0.5) translateX(-20px); }
    25% { opacity: 1; transform: scale(1.2) translateX(0); }
    50% { opacity: 1; transform: scale(1.3) translateX(20px); }
    75% { opacity: 1; transform: scale(1.2) translateX(40px); }
    100% { opacity: 0; transform: scale(0.5) translateX(60px); }
}

@keyframes glowEffect {
    0% { opacity: 0; transform: scale(0.8); filter: brightness(1); }
    25% { opacity: 0.8; transform: scale(1.1); filter: brightness(1.3); }
    50% { opacity: 1; transform: scale(1.2); filter: brightness(1.8) drop-shadow(0 0 15px gold); }
    75% { opacity: 0.8; transform: scale(1.1); filter: brightness(1.3); }
    100% { opacity: 0; transform: scale(0.8); filter: brightness(1); }
}

@keyframes singEffect {
    0% { opacity: 0; transform: translateY(20px) scale(0.8); }
    25% { opacity: 0.8; transform: translateY(0) scale(1); }
    50% { opacity: 1; transform: translateY(-10px) scale(1.1); }
    75% { opacity: 0.8; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(20px) scale(0.8); }
}

@keyframes waterEffect {
    0% { opacity: 0; transform: scale(0.8) rotate(0deg); }
    25% { opacity: 0.8; transform: scale(1) rotate(90deg); filter: hue-rotate(90deg) blur(0.5px); }
    50% { opacity: 1; transform: scale(1.1) rotate(180deg); filter: hue-rotate(180deg) blur(1px); }
    75% { opacity: 0.8; transform: scale(1) rotate(270deg); filter: hue-rotate(270deg) blur(0.5px); }
    100% { opacity: 0; transform: scale(0.8) rotate(360deg); filter: hue-rotate(360deg) blur(0px); }
}

@keyframes invisibleEffect {
    0% { opacity: 1; }
    25% { opacity: 0.5; }
    50% { opacity: 0; }
    75% { opacity: 0.5; }
    100% { opacity: 1; }
}

@keyframes flyingEffect {
    0% { transform: translateY(0); }
    25% { transform: translateY(-30px); }
    50% { transform: translateY(-60px); }
    75% { transform: translateY(-30px); }
    100% { transform: translateY(0); }
}

@keyframes fastMovingEffect {
    0% { transform: translateX(0); }
    20% { transform: translateX(40px); }
    40% { transform: translateX(-40px); }
    60% { transform: translateX(40px); }
    80% { transform: translateX(-40px); }
    100% { transform: translateX(0); }
}

@keyframes giantEffect {
    0% { transform: scale(1); }
    50% { transform: scale(1.8); }
    100% { transform: scale(1); }
}

@keyframes tinyEffect {
    0% { transform: scale(1); }
    50% { transform: scale(0.4); }
    100% { transform: scale(1); }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .pet-image-sidebar {
        position: relative;
        width: 100%;
        height: auto;
        padding: 1rem;
        background: transparent;
    }
    
    .large-pet-image {
        max-width: 300px;
    }
    
    .pet-name-sidebar {
        font-size: 1.5rem;
    }
}

@media (max-width: 576px) {
    .large-pet-image {
        max-width: 250px;
    }
    
    .pet-name-sidebar {
        font-size: 1.3rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const careButtons = document.querySelectorAll('.care-btn');
    const petImage = document.getElementById('interactivePetImage');
    const traitEffectOverlay = document.getElementById('traitEffectOverlay');
    const traitEffectImage = document.getElementById('traitEffectImage');
    const careEffectOverlay = document.getElementById('careEffectOverlay');
    const careEffectImage = document.getElementById('careEffectImage');
    
    // Audio files for care actions
    const audioFiles = {
        feed: '/audio/eatingsound.mp3',
        play: '/audio/playingsound.mp3',
        rest: '/audio/sleepingsound.mp3'
    };

    // Care effect images
    const careEffectImages = {
        feed: '/images/eating.gif',
        play: '/images/playing.gif',
        rest: '/images/sleeping.gif'
    };

    // Trait effect images
    const traitEffectImages = {
        'Fire Breath': '/images/traits/fire_breath.png',
        'Glowing': '/images/traits/glowing.png',
        'Can Sing': '/images/traits/singing.gif',
        'Water Breathing': '/images/traits/water_breathing.png'
    };

    // Pet image click handler for trait effects
    if (petImage) {
        petImage.addEventListener('click', function() {
            const trait = this.getAttribute('data-trait');
            
            if (trait && trait !== 'None') {
                activateTraitEffect(trait);
            }
        });
    }

    function activateTraitEffect(trait) {
        const petImage = document.getElementById('interactivePetImage');
        const container = document.getElementById('petImageContainer');
        
        // Remove any existing trait classes
        container.className = 'pet-image-container';
        petImage.className = 'large-pet-image interactive-pet';
        
        // Reset trait effect overlay
        traitEffectOverlay.style.display = 'none';
        traitEffectImage.style.opacity = '0';
        
        switch(trait) {
            case 'Fire Breath':
            case 'Glowing':
            case 'Can Sing':
            case 'Water Breathing':
                // Show overlay effect on pet image
                traitEffectImage.src = traitEffectImages[trait];
                traitEffectOverlay.style.display = 'flex';
                container.classList.add(`trait-${trait.toLowerCase().replace(' ', '-')}`);
                
                setTimeout(() => {
                    traitEffectImage.style.opacity = '1';
                }, 100);
                
                setTimeout(() => {
                    traitEffectImage.style.opacity = '0';
                    setTimeout(() => {
                        traitEffectOverlay.style.display = 'none';
                        container.classList.remove(`trait-${trait.toLowerCase().replace(' ', '-')}`);
                    }, 500);
                }, 2500);
                break;
                
            case 'Invisible':
            case 'Flying':
            case 'Fast Moving':
            case 'Giant':
            case 'Tiny':
                // Apply direct animation to pet image
                container.classList.add(`trait-${trait.toLowerCase().replace(' ', '-')}`);
                
                setTimeout(() => {
                    container.classList.remove(`trait-${trait.toLowerCase().replace(' ', '-')}`);
                }, 3000);
                break;
        }
    }

    function activateCareEffect(action) {
        const container = document.getElementById('petImageContainer');
        
        // Reset care effect overlay
        careEffectOverlay.style.display = 'none';
        careEffectImage.style.opacity = '0';
        
        // Show care effect on pet image
        careEffectImage.src = careEffectImages[action];
        careEffectOverlay.style.display = 'flex';
        container.classList.add(`care-${action}ing`);
        
        setTimeout(() => {
            careEffectImage.style.opacity = '1';
        }, 100);
        
        setTimeout(() => {
            careEffectImage.style.opacity = '0';
            setTimeout(() => {
                careEffectOverlay.style.display = 'none';
                container.classList.remove(`care-${action}ing`);
            }, 500);
        }, 2500);
    }
    
    // Care button handlers
    careButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const action = this.getAttribute('data-action');
            
            // Play sound
            const audio = new Audio(audioFiles[action]);
            audio.play().catch(error => {
                console.log('Audio play failed:', error);
            });
            
            // Show care effect animation on pet image
            activateCareEffect(action);
            
            // Submit the form after animation completes
            setTimeout(() => {
                const form = this.closest('form');
                form.submit();
            }, 3000);
            
            // Disable button to prevent multiple clicks
            this.disabled = true;
        });
    });
});
</script>

<%- include('../partials/footer', { dbStatus: dbStatus }) %>
